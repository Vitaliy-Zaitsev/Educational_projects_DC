# Финальный проект  
## Machine Learning, Data preprocessing, Classification
Посмотреть проект: [Финальный проект.ipynb](https://github.com/Vitaliy-Zaitsev/Educational_projects_DS/blob/main/FINAL_project_the_best/Финальный%20проект.ipynb)
## Использованные библиотеки и инструменты
`Python`, `Pandas`, `Scikit-learn`, `NumPy`, `matplotlib`, `seaborn`, `LightGBM`, `phik`, `Pipeline`, `make_column_transformer`, `SimpleImputer`, `OneHotEncoder`, `TargetEncoder`, `StandardScaler`, `LogisticRegression`, `RandomForestClassifier`, `LGBMClassifier`, `GridSearchCV`
## Задачи проекта
Оператор связи «Ниединогоразрыва.ком» хочет научиться прогнозировать отток клиентов. Если выяснится, что пользователь планирует уйти, ему будут предложены промокоды и специальные условия. Команда оператора собрала персональные данные о некоторых клиентах, информацию об их тарифах и договорах.

**Описание услуг**

Оператор предоставляет два основных типа услуг: 

1. Стационарную телефонную связь. Возможно подключение телефонного аппарата к нескольким линиям одновременно.
2. Интернет. Подключение может быть двух типов: через телефонную линию (DSL*,* от англ. *digital subscriber line*, «цифровая абонентская линия») или оптоволоконный кабель (*Fiber optic*).  

Также доступны такие услуги:

- Интернет-безопасность: антивирус (*DeviceProtection*) и блокировка небезопасных сайтов (*OnlineSecurity*);
- Выделенная линия технической поддержки (*TechSupport*);
- Облачное хранилище файлов для резервного копирования данных (*OnlineBackup*);
- Стриминговое телевидение (*StreamingTV*) и каталог фильмов (*StreamingMovies*).

За услуги клиенты могут платить каждый месяц или заключить договор на 1–2 года. Доступны различные способы расчёта и возможность получения электронного чека.

**Описание данных**

Данные состоят из файлов, полученных из разных источников:

- `contract_new.csv` — информация о договоре;
- `personal_new.csv` — персональные данные клиента;
- `internet_new.csv` — информация об интернет-услугах;
- `phone_new.csv` — информация об услугах телефонии.

Во всех файлах столбец `customerID` содержит код клиента.

Информация о договорах актуальна на 1 февраля 2020.

## Описание проекта
### Итоги первичного анализа

Имеются данные о 7043 клиентах компании. 
Для каждого известна следующая информация:

1. **Информация о договорах**
* Дата заключения договора
* Дата расторжения договора. Если дата отсутствует, это означает, что договор не был расторгнут на момент выгрузки данных.
* Тип договора: на месяц, на один год, на два года.
* Наличие бумажной счет-фактуры
* Способ оплаты: Electronic check, Mailed check, Bank transfer (automatic), Credit card (automatic).
* Ежемесячные сборы
* Общая сумма сборов
2. **Персональная информация о клиентах.**
* Пол
* Относится ли клиент к гражданам старшего возраста
* Семейное положение
* Наличие иждивенцев
3. **Данные об интернет-услугах, оказываемых клиентам.**
* Вид подключения к интернету
* Пользуется ли клиент услугой блокировки небезопасных сайтов
* Пользуется ли клиент услугой облачного хранилища
* Пользуется ли клиент услугой антивируса
* Пользуется ли клиент услугой выделенной линии техподдержки
* Пользуется ли клиент услугой стримингового телевидения
* Пользуетья ли клиент услугой каталога фильмов
4. **Данные об услугах телефонии, оказываемых клиентам**
* Пользуется ли клиент услугой возможности ведения параллельных линий во время звонка

В каждой из таблиц так-же есть столбец с уникальными ID клиента.\
Количество строк в таблицах с данными об интернет-услугах и услугах телефонии различается, что говорит о том, что не все клиенты пользуются всеми услугами компании.

### Вывод по исследовательскому анализу
Компания оказывает два основных типа услуг:

* Телефония
* Интернет

Наибольшая корреляция целевого признака с общей суммой трат клиента.

<img src="https://github.com/Vitaliy-Zaitsev/Educational_projects_DS/assets/120369294/f83106b5-2843-4541-b48c-1312c8b5c8f8" alt="image-1.png" width="600"/>

На графике видно, что среди клиентов, затративших на услуги компании от 1850 до 4600 большой процент покинувших компанию. Общая сумма складываеться из ежемесячных фиксированных оплат по тарифу плюс дополнительные траты на комиссии и т.п..

<img src="https://github.com/Vitaliy-Zaitsev/Educational_projects_DS/assets/120369294/aca8062b-f8fc-4735-a0b9-6b859b6b3f51" alt="image-2.png" />

В основном уходят клиенты, которые были с компанией от 2 до 5 лет. Новые клиенты и те, что с компанией более 5 лет уходят гораздо меньше.

<img src="https://github.com/Vitaliy-Zaitsev/Educational_projects_DS/assets/120369294/65ec53ab-cd6e-4b4c-a7f4-f3cdc9ef76e5" alt="image-3.png" width="600"/>

На графике видно, что доля клиентов покинувших компанию, находится в районе 10-11% в категориях, где сумма ежемесячных платежей не превышает 79 у.е.
В категориях, где сумма ежемесячных платежей превышает 79 долларов этот показатель возрастает с увеличением суммы.

**Исследуем те же критерии для клиентов, пользующихся только услугой телефонии, без интернета.**

<img src="https://github.com/Vitaliy-Zaitsev/Educational_projects_DS/assets/120369294/155c2c1d-1598-44ae-a4f2-fc5bcc6ae7ce" alt="image-5.png" width="600"/>


Аналогично общей картине, среди клиентов, пользующихся исключительно услугами телефонии, с увеличением стоимости услуг повышается доля покинувших компанию клиентов.

<img src="https://github.com/Vitaliy-Zaitsev/Educational_projects_DS/assets/120369294/e678dca5-522b-4bad-8c8f-52c98bfffa48" alt="image-4.png" />


Судя по тепловой карте корреляции общая сумма сборов сильно связана с наличием услуги MultipleLines и типом договора. Наличие услуги MultipleLines также имеет линейную связь связь с размером ежемесячных платежей. Использование услуги MultipleLines повышает размер ежемесячных платежей, что судя по графику выше, влияет на желание клиента покинуть компанию.
Посмотрим, как на целевой признак исследуемой категории влияет срок, на который заключён договор: месяц, год или два года.

<img src="https://github.com/Vitaliy-Zaitsev/Educational_projects_DS/assets/120369294/6d0c0e16-ff6b-46d4-b256-dd24ef481ee2" alt="image-6.png" width="600"/>


На графике видно, что клиентов абсолютно все устраивает, если они пользуються только услугами телефонии и оплачивают их каждый месяц.

**Резюме:** Возможно стоит пересмотреть условия договоров на длительный период. И подробнее изучить, меняется ли стоимость MultipleLines в зависимости от того, на какой срок заключается договор.**

**Исследуем категорию клиентов, которые пользуются только интернет услугами.**

На первое место по значению корреляции с целевым признаком, помимо TotalCharges, попал признак с методом оплаты.

<img src="https://github.com/Vitaliy-Zaitsev/Educational_projects_DS/assets/120369294/82d78f22-2fec-4114-a796-e82eb9762b3e" alt="image-7.png" width="600"/>

<img src="https://github.com/Vitaliy-Zaitsev/Educational_projects_DS/assets/120369294/1edf99d9-c19f-4de5-a780-5194a21a0e33" alt="image-8.png" width="600"/>

<img src="https://github.com/Vitaliy-Zaitsev/Educational_projects_DS/assets/120369294/ab378b73-1614-44a1-8366-756f27e6f563" alt="image-9.png" width="600"/>


Распределение целевого признака по категориям TotalCharges примерно такое же, что мы видели ранее. Клиенты покидают компанию не сразу.
Это подтверждается тем, что клиенты этой категории использующие тип оплаты раз в год и раз в два года уходят в два раза чаще, чем те, что платят раз в месяц.
Так же видно, что есть проблемы с электронными и автоматическими типами оплаты. Так как это не относится непосредственно к определенной услуге, то имеет смысл посмотреть на эту проблему в масштабе всей компании.

<img src="https://github.com/Vitaliy-Zaitsev/Educational_projects_DS/assets/120369294/875a20a3-7cf6-442a-adc1-aaac0ebf3c4a" alt="image-10.png" width="600"/>

В разрезе всей компании проблема обозначилась более четко: клиенты, использующие автоматические методы оплаты, покидают компанию в три раза чаще, чем клиенты, которые платят наличкой.

Относительно высокую корреляцию с целевым признаком в разрезе всей компании так же имеет столбец Partner, содержащий информацию состоит ли клиент в браке.

<img src="https://github.com/Vitaliy-Zaitsev/Educational_projects_DS/assets/120369294/c9d1104f-d469-4737-a5f0-5e36fd2c0ba0" alt="image-11.png" width="600"/>

Среди клиентов компании, которые состоят в браке, процент покинувших компанию в 2 раза выше, чем среди холостых.
Высокой корреляции у этого признака с другими не наблюдается. Возможно причина в комплексе факторов и эта проблема следует из перечисленных выше.

**Итог**

Исследование позволило создать примерный портрет клиента, который возможно покинет компанию:
* Ежемесячный платеж от 79 долларов и выше
* Пользуется предоплатными типами договора (оплата раз в год или раз в два года)
* Пользуется автоматическими способами оплаты (Bank transfer или Credit card)
### Удаление неинформативных признаков

Посмотрим еще раз на тепловую карту корреляции

<img src="https://github.com/Vitaliy-Zaitsev/Educational_projects_DS/assets/120369294/199b5d99-5eaa-4ef7-bb14-93a0da72b2c5" alt="image-12.png" width="800"/>

* Удаляем признак gender. Пол клиента вообще никак не связан ни с одной из категорий.
* Удаляем признак SeniorCitizen.У этого признака есть есть небольшая корреляция с методами оплаты услуг, это может быть причиной не совсем нулевой корреляции с целевым признаком. Но вряд ли говорит о том, что пожилые люди покидают компанию просто из-за своего возраста.
* Удаляем признак Dependents. У этого признака высокая корреляция с семейным положением, отсюда и ненулевая корреляция с целевым признаком. 
* Удаляем признак PaperlessBilling. Имеется или нет накладная на бумажном носителе мало влияет на целевой признак.
* Блок признаков с наличием тех или иных интеренет услуг и InternetService имеет высокую мультиколлинеарность. Из всех этих признаков оставим только OnlineBackup и StreamingMovies, так как у них самая высока корреляция с целевым признаком

Созданный нами признак duration имеет высокую корреляцию с таргетом. Это объясняется тем, что компания оказывает услуги по предоплате. Клиент не покидает компанию до окончания оплаченного периода: месяц, год, два года. Т.о., если у клиента договор на год, и с момента его заключения прошло всего несколько месяцев, вероятность того, что он покинет компанию в ближайшее время довольно низкая. Соответственно ближе к концу действия договора эта вероятность возрастает, если портрет клиента совпадает с описанным выше.



### Обучение моделей
- Создаем трансформеры для преобразования данных
- Определяем категориальные и дискретные признаки
- Прописываем пайплайны с разными алгоритмами кодирования категориальных признаков и список с гиперпараметрами для перебора по сетке.
- Исследуюмые модели:
  * LogisticRegression
  * RandomForestClassifier
  * LGBMClassifier
- Подбираем гиперпараметры и обучаем модели
  * Лучшая модель:
  ```python
  LGBMClassifier(
   is_unbalance=False,
   max_depth=2,
   metric='roc_auc',
   n_estimators=800,
   objective='binary',
   random_state=50623
  )
  ```
  * Pipeline\
        ![image](https://github.com/Vitaliy-Zaitsev/Educational_projects_DS/assets/120369294/022d5f15-e137-4a48-ab70-b33fb3130b1c)

- Итоговые метрики ROC_AUC для всех исследуемых моделей двумя вариантами энкодеров категориальных признаков:
    ![image](https://github.com/Vitaliy-Zaitsev/Educational_projects_DS/assets/120369294/e227239c-326d-4ded-8a56-25d1118b6d6d)

### Тестируем лучшую модель
**На тесте лучшая модель показала:**
* **ROC_AUC: 0.918**
* **Accuracy: 0.916**

### Анализ важности признаков
![image](https://github.com/Vitaliy-Zaitsev/Educational_projects_DS/assets/120369294/8ecc4a70-1996-413e-b830-20ba39cc901e)


**Вывод:** 

На первом месте кол-во дней, сколько прошло с даты заключения договора.\
Далее идет сумма ежемесячной оплаты и общая сумма сборов.\
Далее идет срок, на который заключен договор, наличие услуги MultipleLines и метод оплаты. Подтвердились выводы исследовательского анализа, что существуют какие-то проблемы с договорами, заключенными на длительный срок и автоматическими методами оплаты.\
Далее идет факт подключения услуги стримингового тв. У этого признака так же была высокая корреляция с таргетом. Возможно у этой услуги завышенная стоимость или есть проблемы с качеством.

Важные признаки, которые зависят от условий компании, это метод оплаты, тип договора, услуги стримингового TV и MultipleLines.

### Анализ матрицы ошибок
![image](https://github.com/Vitaliy-Zaitsev/Educational_projects_DS/assets/120369294/f23aa76d-e281-49f8-b506-69fb297ef733)
![image](https://github.com/Vitaliy-Zaitsev/Educational_projects_DS/assets/120369294/7e86fa2f-ec2c-4e15-b79f-0edcd132af05)
![image](https://github.com/Vitaliy-Zaitsev/Educational_projects_DS/assets/120369294/2eaded04-1901-442a-b370-605b709c676a)



**Вывод:**

В нашей тестовой выборке данные от 1761 клиенте. 

При пороговом значении 0,15 мы имеем следующие результаты модели:

275 клиентов покинули компанию.
* 227 предсказано верно.
* 48 неверно.

1486 не покинули компанию.
* 1219 предсказано верно.
* 267 неверно.

Нужно отметить, что часть клиентов, из ошибочно распределенных в целевую категорию, могли покинуть компанию после даты выгрузки базы.

При пороговом значении равном 0,15 в 82,5% случаев модель верно предсказывает целевой признак. Изменением порогового значения можно увеличить точность, но это приведет к увеличению количества клиентов, которые будут ошибочно определены моделью, как планирующие покинуть компанию. Это увеличит расходы на маркетинговые акции, направленные на удержание целевой категории клиентов. 


## Итоговый вывод
На этапе разработки...

Посмотреть проект: [Построение модели определения стоимости автомобиля](https://github.com/Vitaliy-Zaitsev/Educational_projects_DS/blob/main/Educational_project_7_ML_Data_preprocessing/Численные%20методы.ipynb)
 



#### [Список всех учебных проектов](https://github.com/Vitaliy-Zaitsev/Educational_projects_DS/blob/main/README.md)







